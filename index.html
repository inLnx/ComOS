<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ComOS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for the OS look and feel */
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            user-select: none;
        }

        /* Indeterminate progress bar animation */
        .progress-bar-inner {
            animation: indeterminate-progress 2s infinite linear;
        }

        @keyframes indeterminate-progress {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(250%); }
        }

        /* Styling for draggable windows and icons */
        .app-window, .app-icon {
            position: absolute;
        }
        .app-window {
            display: none;
            resize: both;
            overflow: auto;
        }
        /* Custom apps have their own styling, but need a base class */
        .custom-app-window {
             min-width: 100px;
             min-height: 50px;
        }
        /* Disable resizing for specific apps */
        #voice-assistant-app, #snake-game, #pong-game, #tictactoe-game, #music-app {
            resize: none;
        }
        .app-icon {
            width: 96px; /* Fixed width for desktop icons */
        }

        .title-bar {
            cursor: move;
        }
        
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.1);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0,0,0,0.5);
        }

        /* Voice Assistant listening animation */
        .mic-listening {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4); }
            70% { box-shadow: 0 0 0 15px rgba(255, 255, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
        }
        
        /* Custom context menu */
        #context-menu {
            display: none;
            position: absolute;
            z-index: 1000;
        }
        
        /* Floating close button for custom apps */
        .close-btn-floating {
            position: absolute;
            top: 8px;
            right: 8px;
            z-index: 10;
        }

        /* Tic-Tac-Toe styles */
        .tic-tac-toe-grid {
            display: grid;
            grid-template-columns: repeat(3, 100px);
            grid-template-rows: repeat(3, 100px);
            gap: 5px;
        }
        .tic-tac-toe-cell {
            width: 100px;
            height: 100px;
            background-color: #e2e8f0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            font-weight: bold;
            cursor: pointer;
            color: #4a5568;
        }
    </style>
</head>
<body class="bg-gray-800">

    <!-- Startup Screen -->
    <div id="startup-screen" class="fixed inset-0 bg-[#2C2A2A] flex flex-col items-center justify-center z-50">
        <h1 class="text-white text-8xl font-light mb-12">ComOS</h1>
        <div class="w-1/3 max-w-sm bg-gray-500 rounded-full h-2.5 overflow-hidden">
            <div class="progress-bar-inner bg-gray-200 h-2.5 rounded-full w-1/3"></div>
        </div>
        <p class="text-gray-300 mt-4 text-sm">Loading...</p>
    </div>

    <!-- Desktop Environment -->
    <div id="desktop" class="hidden h-screen w-screen bg-cover bg-center" style="background-image: url('https://placehold.co/1920x1080/6E6570/FFFFFF?text=Welcome')">
        
        <!-- App Icons on Desktop -->
        <div id="desktop-icons" class="w-full h-full relative">
             <div class="app-icon text-center cursor-pointer top-4 left-4" data-app-id="browser-app">
                <img src="https://img.icons8.com/color/96/000000/chrome.png" alt="Browser" class="h-16 w-16 mx-auto">
                <p class="text-white text-sm mt-1">Browser</p>
            </div>
             <div class="app-icon text-center cursor-pointer top-28 left-4" data-app-id="voice-assistant-app">
                <img src="https://img.icons8.com/color/96/000000/google-assistant.png" alt="Assistant" class="h-16 w-16 mx-auto">
                <p class="text-white text-sm mt-1">Assistant</p>
            </div>
             <div class="app-icon text-center cursor-pointer top-52 left-4" data-app-id="games-app">
                <img src="https://img.icons8.com/color/96/000000/controller.png" alt="Games" class="h-16 w-16 mx-auto">
                <p class="text-white text-sm mt-1">Games</p>
            </div>
             <div class="app-icon text-center cursor-pointer top-[28rem] left-4" data-app-id="app-store">
                <img src="https://img.icons8.com/fluency/96/000000/app-store.png" alt="App Store" class="h-16 w-16 mx-auto">
                <p class="text-white text-sm mt-1">App Store</p>
            </div>
        </div>

        <!-- App Windows Container -->
        <div id="app-windows-container">
            <!-- Voice Assistant App -->
            <div id="voice-assistant-app" class="app-window w-[450px] h-auto top-16 right-4 bg-gray-800/80 backdrop-blur-xl rounded-lg shadow-2xl flex flex-col p-4">
                <div class="flex items-center justify-between w-full">
                    <button id="mic-btn" class="flex-shrink-0 bg-transparent text-white w-16 h-16 rounded-full flex items-center justify-center transition-all">
                         <img src="https://img.icons8.com/ios-filled/50/ffffff/microphone.png" alt="Microphone" class="h-8 w-8"/>
                    </button>
                    <div class="flex-grow text-left ml-4">
                         <p id="assistant-status" class="text-gray-300 text-lg">Go ahead, I'm listening...</p>
                         <p id="user-transcription" class="text-gray-400 text-sm min-h-[20px]"></p>
                    </div>
                    <button class="close-btn flex-shrink-0 bg-gray-500/50 w-6 h-6 rounded-full text-white hover:bg-red-500 flex items-center justify-center">X</button>
                </div>
            </div>

            <!-- Browser App -->
            <div id="browser-app" class="app-window w-3/4 h-3/4 top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-gray-200 rounded-lg shadow-2xl flex flex-col">
                <div class="title-bar bg-gray-300 p-2 rounded-t-lg flex items-center justify-between">
                    <span class="font-bold">Web Browser</span>
                    <button class="close-btn bg-red-500 w-5 h-5 rounded-full hover:bg-red-600"></button>
                </div>
                <div class="p-2 bg-gray-200 flex items-center space-x-2">
                     <input id="url-input" type="text" placeholder="Enter URL and press Enter" class="flex-grow p-2 rounded-full border-2 border-gray-300 focus:outline-none focus:border-pink-300">
                     <button id="go-btn" class="bg-pink-200 text-gray-700 px-4 py-2 rounded-full hover:bg-pink-300">Go</button>
                </div>
                <div class="flex-grow bg-white">
                    <iframe id="browser-frame" class="w-full h-full border-0"></iframe>
                </div>
            </div>
            
            <!-- Music Player App (Deezer) -->
            <div id="music-app" class="app-window w-[400px] h-[550px] top-[15%] left-[35%] bg-gray-100 rounded-lg shadow-2xl flex flex-col">
                <div class="title-bar bg-gray-800 text-white p-2 rounded-t-lg flex items-center justify-between">
                    <span class="font-bold">Music</span>
                    <button class="close-btn bg-red-500 w-5 h-5 rounded-full hover:bg-red-600"></button>
                </div>
                <div class="p-4 flex-shrink-0">
                    <div class="flex space-x-2">
                        <input id="deezer-search-input" type="text" placeholder="Search for a song..." class="flex-grow p-2 rounded-l-lg border-2 border-gray-300 focus:outline-none focus:border-purple-400">
                        <button id="deezer-search-btn" class="bg-purple-500 text-white px-4 rounded-r-lg hover:bg-purple-600">Search</button>
                    </div>
                </div>
                <div id="deezer-results" class="flex-grow overflow-y-auto p-4 space-y-2">
                    <!-- Search results will appear here -->
                </div>
                <div id="deezer-player-bar" class="p-2 bg-white border-t-2 flex-shrink-0">
                     <audio id="deezer-audio-player" controls class="w-full"></audio>
                     <div class="text-center mt-1">
                         <p id="deezer-song-title" class="font-semibold truncate">No song selected</p>
                         <p id="deezer-artist-name" class="text-sm text-gray-600 truncate">-</p>
                     </div>
                </div>
            </div>

            <!-- Camera App -->
            <div id="camera-app" class="app-window w-[640px] h-auto top-[25%] left-[40%] bg-gray-200 rounded-lg shadow-2xl flex flex-col">
                <div class="title-bar bg-gray-300 p-2 rounded-t-lg flex items-center justify-between">
                    <span class="font-bold">Camera</span>
                    <button class="close-btn bg-red-500 w-5 h-5 rounded-full hover:bg-red-600"></button>
                </div>
                <div class="p-4 flex flex-col items-center justify-center flex-grow">
                    <video id="camera-feed" autoplay class="w-full h-auto bg-black rounded-lg mb-4"></video>
                    <canvas id="camera-canvas" class="hidden"></canvas>
                    <button id="capture-btn" class="w-full text-center bg-pink-200 text-gray-700 px-4 py-3 rounded-full hover:bg-pink-300 cursor-pointer">Capture Photo</button>
                     <div id="photo-output" class="mt-4"></div>
                </div>
            </div>
            
            <!-- Weather App -->
            <div id="weather-app" class="app-window w-80 h-auto top-[30%] left-[60%] bg-gray-200 rounded-lg shadow-2xl flex flex-col">
                <div class="title-bar bg-gray-300 p-2 rounded-t-lg flex items-center justify-between">
                    <span class="font-bold">Weather</span>
                    <button class="close-btn bg-red-500 w-5 h-5 rounded-full hover:bg-red-600"></button>
                </div>
                <div class="p-4 flex flex-col items-center justify-center flex-grow">
                    <input id="location-input" type="text" placeholder="Enter location" class="w-full p-3 mb-4 rounded-full border-2 border-gray-300 focus:outline-none focus:border-pink-300">
                    <div id="weather-forecast" class="w-full h-32 bg-[#BCA8AC] rounded-lg p-4 text-white">
                        <p>Enter a location to see the forecast.</p>
                    </div>
                </div>
            </div>

            <!-- Wallpaper Picker App -->
            <div id="wallpapers-app" class="app-window w-[500px] h-auto top-[40%] left-[10%] bg-gray-200 rounded-lg shadow-2xl flex flex-col">
                <div class="title-bar bg-gray-300 p-2 rounded-t-lg flex items-center justify-between">
                    <span class="font-bold">Wallpapers</span>
                    <button class="close-btn bg-red-500 w-5 h-5 rounded-full hover:bg-red-600"></button>
                </div>
                <div class="p-4 flex flex-wrap gap-4 justify-center">
                    <div class="wallpaper-option w-40 h-24 rounded-lg cursor-pointer bg-cover bg-center" style="background-color: #BCA8AC;" data-bg="#BCA8AC"></div>
                    <div class="wallpaper-option w-40 h-24 rounded-lg cursor-pointer bg-cover bg-center" style="background-color: #EAD8DC;" data-bg="#EAD8DC"></div>
                    <div class="wallpaper-option w-40 h-24 rounded-lg cursor-pointer bg-cover bg-center" style="background-image: url('https://placehold.co/400x240/3a5a40/FFFFFF?text=Nature')" data-bg="url('https://placehold.co/1920x1080/3a5a40/FFFFFF?text=Nature')"></div>
                    <div class="wallpaper-option w-40 h-24 rounded-lg cursor-pointer bg-cover bg-center" style="background-image: url('https://placehold.co/400x240/3d405b/FFFFFF?text=City')" data-bg="url('https://placehold.co/1920x1080/3d405b/FFFFFF?text=City')"></div>
                </div>
            </div>

            <!-- App Store App -->
            <div id="app-store" class="app-window w-[500px] h-auto top-[20%] left-[45%] bg-gray-200 rounded-lg shadow-2xl flex flex-col">
                <div class="title-bar bg-gray-300 p-2 rounded-t-lg flex items-center justify-between">
                    <span class="font-bold">App Store</span>
                    <button class="close-btn bg-red-500 w-5 h-5 rounded-full hover:bg-red-600"></button>
                </div>
                <form id="add-app-form" class="p-4 space-y-4">
                    <h2 class="text-xl font-semibold text-gray-700">Create a New App</h2>
                    <div>
                        <label for="app-name-input" class="block text-sm font-medium text-gray-600">App Name</label>
                        <input type="text" id="app-name-input" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="app-icon-input" class="block text-sm font-medium text-gray-600">Icon URL (PNG)</label>
                        <input type="url" id="app-icon-input" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="app-handle-input" class="block text-sm font-medium text-gray-600">Draggable Handle Selector (Optional)</label>
                        <input type="text" id="app-handle-input" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 font-mono text-sm" placeholder=".your-drag-handle-class">
                    </div>
                    <div>
                        <label for="app-html-input" class="block text-sm font-medium text-gray-600">App Window HTML</label>
                        <textarea id="app-html-input" rows="6" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 font-mono text-sm" placeholder="<!-- Your entire window HTML goes here -->"></textarea>
                    </div>
                    <button type="submit" class="w-full bg-indigo-500 text-white py-2 px-4 rounded-md hover:bg-indigo-600">Add App</button>
                </form>
            </div>
            
            <!-- Games App Launcher -->
            <div id="games-app" class="app-window w-[600px] h-auto top-[20%] left-[30%] bg-gray-200 rounded-lg shadow-2xl flex flex-col">
                <div class="title-bar bg-gray-300 p-2 rounded-t-lg flex items-center justify-between">
                    <span class="font-bold">Games</span>
                    <button class="close-btn bg-red-500 w-5 h-5 rounded-full hover:bg-red-600"></button>
                </div>
                <div class="p-6 grid grid-cols-3 gap-6">
                    <div class="game-icon text-center cursor-pointer p-4 rounded-lg hover:bg-gray-300" data-app-id="snake-game">
                        <img src="https://img.icons8.com/color/96/000000/snake.png" alt="Snake" class="h-24 w-24 mx-auto">
                        <p class="text-gray-700 font-semibold mt-2">Snake</p>
                    </div>
                    <div class="game-icon text-center cursor-pointer p-4 rounded-lg hover:bg-gray-300" data-app-id="pong-game">
                        <img src="https://img.icons8.com/color/96/000000/ping-pong.png" alt="Pong" class="h-24 w-24 mx-auto">
                        <p class="text-gray-700 font-semibold mt-2">Pong</p>
                    </div>
                    <div class="game-icon text-center cursor-pointer p-4 rounded-lg hover:bg-gray-300" data-app-id="tictactoe-game">
                        <img src="https://img.icons8.com/color/96/000000/tic-tac-toe.png" alt="Tic-Tac-Toe" class="h-24 w-24 mx-auto">
                        <p class="text-gray-700 font-semibold mt-2">Tic-Tac-Toe</p>
                    </div>
                </div>
            </div>

            <!-- Snake Game Window -->
            <div id="snake-game" class="app-window w-[440px] h-[490px] top-1/4 left-1/4 bg-gray-800 flex-col">
                <div class="title-bar text-white p-2 flex justify-between items-center">
                    <span>Snake</span>
                    <button class="close-btn bg-red-500 w-5 h-5 rounded-full hover:bg-red-600"></button>
                </div>
                <div class="p-4">
                    <canvas id="snake-canvas" width="400" height="400" class="bg-black"></canvas>
                    <div id="snake-score" class="text-white text-center mt-2">Score: 0</div>
                </div>
            </div>

             <!-- Pong Game Window -->
            <div id="pong-game" class="app-window w-[640px] h-[510px] top-1/3 left-1/3 bg-gray-800 flex-col">
                <div class="title-bar text-white p-2 flex justify-between items-center">
                    <span>Pong</span>
                    <button class="close-btn bg-red-500 w-5 h-5 rounded-full hover:bg-red-600"></button>
                </div>
                 <div class="p-4">
                    <canvas id="pong-canvas" width="600" height="400" class="bg-black"></canvas>
                    <div id="pong-score" class="text-white text-center mt-2">Player: 0 | AI: 0</div>
                </div>
            </div>

            <!-- Tic-Tac-Toe Game Window -->
            <div id="tictactoe-game" class="app-window w-auto h-auto top-1/4 left-1/2 bg-gray-100 flex-col p-4 space-y-4">
                 <div class="title-bar text-gray-800 font-bold text-xl text-center">Tic-Tac-Toe</div>
                 <div id="tictactoe-grid" class="tic-tac-toe-grid"></div>
                 <div id="tictactoe-status" class="text-center font-semibold">Player X's turn</div>
                 <button id="tictactoe-reset" class="w-full bg-indigo-500 text-white py-2 rounded-lg">Reset Game</button>
                 <button class="close-btn absolute top-2 right-2 bg-red-500 w-5 h-5 rounded-full hover:bg-red-600"></button>
            </div>
        </div>
        
        <!-- App Drawer -->
        <div id="app-drawer" class="hidden absolute inset-0 bg-black/50 backdrop-blur-md z-20 flex items-center justify-center">
            <div id="app-drawer-grid" class="grid grid-cols-4 gap-8 p-8">
                
            </div>
        </div>

        
        <div class="absolute bottom-4 left-1/2 -translate-x-1/2 z-30">
            <div class="flex items-center space-x-3 bg-gray-900/50 backdrop-blur-xl p-3 rounded-2xl shadow-lg">
                <div id="launcher-btn" class="dock-icon cursor-pointer">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>
                </div>
                <div id="pinned-apps" class="flex items-center space-x-3"></div>
            </div>
        </div>

        <div id="context-menu" class="bg-white rounded-md shadow-lg py-1 w-40">
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA ---
            const APPS = {
                'browser-app': { name: 'Web', icon: 'https://img.icons8.com/color/96/000000/chrome.png', pinned: true },
                'voice-assistant-app': { name: 'Assistant', icon: 'https://img.icons8.com/color/96/000000/google-assistant.png', pinned: true },
                'music-app': { name: 'Music', icon: 'https://img.icons8.com/color/96/000000/deezer.png', pinned: false },
                'camera-app': { name: 'Camera', icon: 'https://img.icons8.com/color/96/000000/camera.png', pinned: false },
                'weather-app': { name: 'Weather', icon: 'https://img.icons8.com/color/96/000000/partly-cloudy-day.png', pinned: true },
                'wallpapers-app': { name: 'Wallpapers', icon: 'https://img.icons8.com/color/96/000000/image-file.png', pinned: false },
                'app-store': { name: 'App Store', icon: 'https://img.icons8.com/fluency/96/000000/app-store.png', pinned: false },
                'games-app': { name: 'Games', icon: 'https://img.icons8.com/color/96/000000/controller.png', pinned: false },
            };

            
            const startupScreen = document.getElementById('startup-screen');
            const desktop = document.getElementById('desktop');
            const desktopIconsContainer = document.getElementById('desktop-icons');
            const appWindowsContainer = document.getElementById('app-windows-container');
            const appDrawer = document.getElementById('app-drawer');
            const appDrawerGrid = document.getElementById('app-drawer-grid');
            const launcherBtn = document.getElementById('launcher-btn');
            const pinnedAppsContainer = document.getElementById('pinned-apps');
            const contextMenu = document.getElementById('context-menu');
            const cameraFeed = document.getElementById('camera-feed');
            let cameraStream = null;
            let highestZ = 10;
            let gameIntervals = {};
            // A state to track if games are initialized to prevent re-initialization
            let gamesInitialized = {
                snake: false,
                pong: false,
                tictactoe: false
            };

            // --- INITIALIZATION 
            function initializeOS() {
                document.querySelectorAll('.app-window').forEach(win => win.style.display = 'none');
                setTimeout(() => {
                    startupScreen.style.display = 'none';
                    desktop.style.display = 'block';
                }, 2000);
                updateClock();
                setInterval(updateClock, 1000);
                renderAllIcons();
                makeElementsDraggable('.app-window:not(.custom-app-window, #tictactoe-game)', '.title-bar');
                makeElementsDraggable('.app-icon', null, desktopIconsContainer);
                initializeAllAppLogic();
            }

            // ----
            function renderAllIcons() {
                appDrawerGrid.innerHTML = '';
                pinnedAppsContainer.innerHTML = '';
                for (const id in APPS) {
                    const app = APPS[id];
                    appDrawerGrid.appendChild(createIcon(id, app, 'drawer'));
                    if (app.pinned) {
                        pinnedAppsContainer.appendChild(createIcon(id, app, 'dock'));
                    }
                }
            }

            function createIcon(id, appData, type) {
                const iconWrapper = document.createElement('div');
                iconWrapper.dataset.appId = id;
                if (type === 'dock') {
                    iconWrapper.className = 'dock-icon cursor-pointer';
                    iconWrapper.innerHTML = `<img src="${appData.icon}" alt="${appData.name}" class="h-12 w-12">`;
                } else {
                    iconWrapper.className = 'app-drawer-icon text-center cursor-pointer p-2 rounded-lg hover:bg-white/20';
                    iconWrapper.innerHTML = `<img src="${appData.icon}" alt="${appData.name}" class="h-16 w-16 mx-auto"><p class="text-white text-sm mt-2 truncate">${appData.name}</p>`;
                    iconWrapper.addEventListener('contextmenu', (e) => showContextMenu(e, id));
                }
                return iconWrapper;
            }

            
            async function openApp(appId) {
                const appWindow = document.getElementById(appId);
                if (appWindow) {
                    appWindow.style.display = 'flex';
                    highestZ++;
                    appWindow.style.zIndex = highestZ;
                    appDrawer.style.display = 'none';
                    
                    // --- MODIFIED LOGIC: Initialize and start games on open ---
                    if (appId === 'snake-game') {
                        if (!gamesInitialized.snake) {
                            initializeSnakeGame();
                        }
                        startSnakeGame();
                    }
                    if (appId === 'pong-game') {
                        if (!gamesInitialized.pong) {
                            initializePongGame();
                        }
                        startPongGame();
                    }
                     if (appId === 'tictactoe-game') {
                        if (!gamesInitialized.tictactoe) {
                           initializeTicTacToeGame();
                        }
                        startTicTacToeGame();
                    }
                    // --- End of modification ---

                    if (appId === 'camera-app' && !cameraStream) {
                        try {
                            cameraStream = await navigator.mediaDevices.getUserMedia({ video: true });
                            cameraFeed.srcObject = cameraStream;
                        } catch (err) { console.error("Camera error:", err); }
                    }
                }
            }

            function closeApp(appWindow) {
                 if (appWindow) {
                    appWindow.style.display = 'none';
                    if (appWindow.id === 'camera-app') stopCamera();
                    if (appWindow.id === 'voice-assistant-app') stopVoiceAssistant();
                    // Stop game loop when window is closed
                    if (gameIntervals[appWindow.id]) {
                        clearInterval(gameIntervals[appWindow.id]);
                        delete gameIntervals[appWindow.id];
                    }
                }
            }
            
            function updateClock() {
                const clockElement = document.getElementById('clock');
                if (!clockElement) return;
                const now = new Date();
                const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const dateString = now.toLocaleDateString([], { weekday: 'short', month: 'short', day: 'numeric' });
                clockElement.textContent = `${dateString} ${timeString}`;
            }

            
            function makeElementsDraggable(selector, handleSelector, container = document.body) {
                document.querySelectorAll(selector).forEach(el => {
                    let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
                    const handle = handleSelector ? el.querySelector(handleSelector) : el;
                    if (handle) {
                        handle.onmousedown = dragMouseDown;
                    }
                    function dragMouseDown(e) {
                        e.preventDefault();
                        pos3 = e.clientX;
                        pos4 = e.clientY;
                        if (el.classList.contains('app-window')) {
                            highestZ++;
                            el.style.zIndex = highestZ;
                        }
                        document.onmouseup = closeDragElement;
                        document.onmousemove = elementDrag;
                    }
                    function elementDrag(e) {
                        e.preventDefault();
                        pos1 = pos3 - e.clientX;
                        pos2 = pos4 - e.clientY;
                        pos3 = e.clientX;
                        pos4 = e.clientY;
                        let newTop = el.offsetTop - pos2;
                        let newLeft = el.offsetLeft - pos1;
                        if (container !== document.body) {
                            const contRect = container.getBoundingClientRect();
                            const elRect = el.getBoundingClientRect();
                            if (newLeft < 0) newLeft = 0;
                            if (newTop < 0) newTop = 0;
                            if (newLeft + elRect.width > contRect.width) newLeft = contRect.width - elRect.width;
                            if (newTop + elRect.height > contRect.height) newTop = contRect.height - elRect.height;
                        }
                        el.style.top = newTop + "px";
                        el.style.left = newLeft + "px";
                    }
                    function closeDragElement() {
                        document.onmouseup = null;
                        document.onmousemove = null;
                    }
                });
            }

            // --- CONTEXT MENU ---
            function showContextMenu(e, appId) {
                e.preventDefault();
                contextMenu.style.top = `${e.clientY}px`;
                contextMenu.style.left = `${e.clientX}px`;
                contextMenu.style.display = 'block';
                const isPinned = APPS[appId].pinned;
                const pinActionText = isPinned ? 'Unpin from Dock' : 'Pin to Dock';
                contextMenu.innerHTML = `<a href="#" data-action="toggle-pin" data-app-id="${appId}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">${pinActionText}</a>`;
            }

            function togglePin(appId) {
                APPS[appId].pinned = !APPS[appId].pinned;
                renderAllIcons();
            }

            // --- EVENT LISTENERS ---
            launcherBtn.addEventListener('click', () => { appDrawer.style.display = appDrawer.style.display === 'flex' ? 'none' : 'flex'; });
            appDrawer.addEventListener('click', (e) => { if (e.target === appDrawer) appDrawer.style.display = 'none'; });
            document.body.addEventListener('click', (e) => {
                const icon = e.target.closest('[data-app-id]');
                if (icon) openApp(icon.dataset.appId);
                const closeBtn = e.target.closest('.close-btn');
                if(closeBtn) closeApp(closeBtn.closest('.app-window'));
                const contextAction = e.target.closest('[data-action]');
                if (contextAction) {
                    if (contextAction.dataset.action === 'toggle-pin') togglePin(contextAction.dataset.appId);
                }
                if (!e.target.closest('#context-menu')) contextMenu.style.display = 'none';
            });
            document.addEventListener('contextmenu', (e) => { if (!e.target.closest('.app-drawer-icon')) contextMenu.style.display = 'none'; });

            // --- APP SPECIFIC LOGIC -
            function initializeAllAppLogic() {
                // App Store
                document.getElementById('add-app-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const name = document.getElementById('app-name-input').value;
                    const iconUrl = document.getElementById('app-icon-input').value;
                    const handle = document.getElementById('app-handle-input').value;
                    const htmlContent = document.getElementById('app-html-input').value;
                    const appId = `custom-app-${Date.now()}`;
                    
                    APPS[appId] = { name, icon: iconUrl, pinned: false };

                    const appWindow = document.createElement('div');
                    appWindow.id = appId;
                    appWindow.className = 'app-window custom-app-window top-1/4 left-1/4';
                    appWindow.innerHTML = htmlContent;
                    
                    const closeBtn = document.createElement('button');
                    closeBtn.className = 'close-btn close-btn-floating bg-red-500 w-5 h-5 rounded-full hover:bg-red-600';
                    appWindow.appendChild(closeBtn);

                    appWindowsContainer.appendChild(appWindow);
                    if (handle) {
                        makeElementsDraggable(`#${appId}`, handle);
                    }
                    renderAllIcons();
                    closeApp(document.getElementById('app-store'));
                    openApp(appId);
                    e.target.reset();
                });

                // Voice Assistant
                const micBtn = document.getElementById('mic-btn');
                const assistantStatus = document.getElementById('assistant-status');
                const userTranscription = document.getElementById('user-transcription');
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                let recognition;
                if (SpeechRecognition) {
                    recognition = new SpeechRecognition();
                    Object.assign(recognition, { continuous: false, lang: 'en-US', interimResults: false, maxAlternatives: 1 });
                    recognition.onstart = () => { assistantStatus.textContent = 'Listening...'; micBtn.classList.add('mic-listening'); };
                    recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        userTranscription.textContent = transcript;
                        assistantStatus.textContent = 'Processing...';
                        callGeminiApi(transcript);
                    };
                    recognition.onerror = (event) => { assistantStatus.textContent = 'Error: ' + event.error; };
                    recognition.onend = () => { micBtn.classList.remove('mic-listening'); if (assistantStatus.textContent === 'Listening...') assistantStatus.textContent = 'Go ahead, I\'m listening...'; };
                    micBtn.addEventListener('click', () => { if (recognition) { userTranscription.textContent = ''; assistantStatus.textContent = 'Listening...'; recognition.start(); }});
                } else {
                    assistantStatus.textContent = 'Speech recognition not supported.';
                    micBtn.disabled = true;
                }
                
                // Deezer Music App
                initializeDeezerApp();

                // Other Apps
                const urlInput = document.getElementById('url-input');
                const goBtn = document.getElementById('go-btn');
                const browserFrame = document.getElementById('browser-frame');
                const captureBtn = document.getElementById('capture-btn');
                const cameraCanvas = document.getElementById('camera-canvas');
                const photoOutput = document.getElementById('photo-output');
                const locationInput = document.getElementById('location-input');
                const forecastDiv = document.getElementById('weather-forecast');
                const wallpaperOptions = document.querySelectorAll('.wallpaper-option');

                goBtn.addEventListener('click', () => { let url = urlInput.value.trim(); if (url && !url.startsWith('http')) { url = 'https://' + url; } browserFrame.src = url; });
                urlInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') goBtn.click(); });
                captureBtn.addEventListener('click', () => { cameraCanvas.width = cameraFeed.videoWidth; cameraCanvas.height = cameraFeed.videoHeight; cameraCanvas.getContext('2d').drawImage(cameraFeed, 0, 0); photoOutput.innerHTML = `<img src="${cameraCanvas.toDataURL('image/png')}" class="rounded-lg border-2 border-pink-300" alt="Captured Photo">`; });
                locationInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { const loc = e.target.value.trim(); if(loc) { forecastDiv.innerHTML = `<p class="font-bold text-lg">${loc}</p><p class="text-4xl">${Math.floor(Math.random()*40+50)}Â°F</p><p>Sunny</p>`; } } });
                wallpaperOptions.forEach(option => { option.addEventListener('click', () => { const bg = option.dataset.bg; if (bg.startsWith('url')) { desktop.style.backgroundImage = bg; desktop.style.backgroundColor = ''; } else { desktop.style.backgroundColor = bg; desktop.style.backgroundImage = ''; } }); });
            
            }

            function stopCamera() { if (cameraStream) { cameraStream.getTracks().forEach(track => track.stop()); cameraStream = null; cameraFeed.srcObject = null; } }

            function speak(text) {
                const assistantStatus = document.getElementById('assistant-status');
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.onstart = () => { assistantStatus.textContent = text; };
                utterance.onend = () => { assistantStatus.textContent = 'Go ahead, I\'m listening...'; };
                speechSynthesis.speak(utterance);
            }
            
            function stopVoiceAssistant() {
                const assistantStatus = document.getElementById('assistant-status');
                const recognition = window.speechRecognition;
                if (recognition) recognition.stop();
                speechSynthesis.cancel();
                if(assistantStatus) assistantStatus.textContent = 'Go ahead, I\'m listening...';
            }

            async function callGeminiApi(prompt) {
                if (!prompt) return;
                try {
                    const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                    const apiKey = ""; 
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`API error: ${response.statusText}`);
                    const result = await response.json();
                    let text = "Sorry, I couldn't get a response.";
                    if (result.candidates?.[0]?.content?.parts?.[0]) {
                        text = result.candidates[0].content.parts[0].text;
                    }
                    speak(text);
                } catch (error) {
                    console.error("Gemini API call failed:", error);
                    speak(`Error: ${error.message}`);
                }
            }

            // --- DEEZER LOGIC (FIXED WITH PROXY FALLBACK) ---
            async function searchDeezer(query) {
                // List of CORS proxy templates. {URL} will be replaced with the encoded API URL.
                const PROXIES = [
                    'https://api.allorigins.win/raw?url={URL}',
                    'https://corsproxy.io/?{URL}',
                    'https://proxy.cors.sh/{URL}',
                    'https://cors-anywhere.herokuapp.com/{URL}'
                ];

                const apiUrl = `https://api.deezer.com/search?q=${encodeURIComponent(query)}`;
                const encodedApiUrl = encodeURIComponent(apiUrl);

                for (const proxyTemplate of PROXIES) {
                    // Construct the full request URL using the current proxy template
                    const requestUrl = proxyTemplate.replace('{URL}', encodedApiUrl);
                    
                    try {
                        console.log(`Trying proxy: ${proxyTemplate.split('/')[2]}`);
                        const response = await fetch(requestUrl);
                        if (response.ok) {
                            const data = await response.json();
                            // The actual content from allorigins is in a `contents` property
                            if (proxyTemplate.includes('allorigins')) {
                                const parsedData = JSON.parse(data.contents);
                                if (parsedData.data) {
                                     console.log(`Success with proxy: ${proxyTemplate.split('/')[2]}`);
                                     return parsedData.data;
                                }
                            }
                            // For other proxies, the data might be direct
                            if (data.data) {
                                console.log(`Success with proxy: ${proxyTemplate.split('/')[2]}`);
                                return data.data;
                            }
                        }
                        // If response is not ok, it will be caught as an error below
                        throw new Error(`Proxy request failed with status: ${response.status}`);
                    } catch (error) {
                        console.error(`Failed to fetch via ${proxyTemplate.split('/')[2]}:`, error);
                        // If a proxy fails, the loop will just continue to the next one.
                    }
                }

                // If all proxies fail, return an empty array.
                console.error('All CORS proxies failed.');
                return [];
            }

            function initializeDeezerApp() {
                const searchBtn = document.getElementById('deezer-search-btn');
                const searchInput = document.getElementById('deezer-search-input');
                const resultsContainer = document.getElementById('deezer-results');
                const audioPlayer = document.getElementById('deezer-audio-player');
                const songTitleEl = document.getElementById('deezer-song-title');
                const artistNameEl = document.getElementById('deezer-artist-name');

                const handleSearch = async () => {
                    const query = searchInput.value.trim();
                    if (!query) return;

                    resultsContainer.innerHTML = '<p class="text-gray-500 text-center">Searching...</p>';
                    const tracks = await searchDeezer(query);
                    displayDeezerResults(tracks);
                };

                searchBtn.addEventListener('click', handleSearch);
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        handleSearch();
                    }
                });

                function displayDeezerResults(tracks) {
                    resultsContainer.innerHTML = '';
                    if (!tracks || tracks.length === 0) {
                        resultsContainer.innerHTML = '<p class="text-gray-500 text-center">No results found. The music service might be unavailable.</p>';
                        return;
                    }
                    tracks.forEach(track => {
                        const trackEl = document.createElement('div');
                        trackEl.className = 'flex items-center p-2 rounded-lg hover:bg-gray-200 cursor-pointer';
                        trackEl.innerHTML = `
                            <img src="${track.album.cover_small}" alt="Album Art" class="w-12 h-12 rounded-md mr-4" onerror="this.src='https://placehold.co/48x48/EFEFEF/CCCCCC?text=Art'">
                            <div>
                                <p class="font-semibold text-gray-800 truncate">${track.title}</p>
                                <p class="text-sm text-gray-600 truncate">${track.artist.name}</p>
                            </div>
                        `;
                        trackEl.addEventListener('click', () => {
                            audioPlayer.src = track.preview;
                            audioPlayer.play();
                            songTitleEl.textContent = track.title;
                            artistNameEl.textContent = track.artist.name;
                        });
                        resultsContainer.appendChild(trackEl);
                    });
                }
            }


             // --- GAME LOGIC ---

            // Snake Game
            let snake, food, score, direction, snakeCanvas, snakeCtx, snakeScoreEl;
            const gridSize = 20;
            function initializeSnakeGame() {
                snakeCanvas = document.getElementById('snake-canvas');
                snakeCtx = snakeCanvas.getContext('2d');
                snakeScoreEl = document.getElementById('snake-score');
                gamesInitialized.snake = true; // Mark as initialized
            }
            function startSnakeGame() {
                if (!snakeCanvas) return; // Guard against race conditions
                snake = [{ x: 10, y: 10 }];
                food = { x: 15, y: 15 };
                score = 0;
                direction = 'right';
                snakeScoreEl.textContent = 'Score: 0';
                if (gameIntervals['snake-game']) clearInterval(gameIntervals['snake-game']);
                gameIntervals['snake-game'] = setInterval(updateSnakeGame, 100);
            }
            function updateSnakeGame() {
                if (!snakeCanvas) return;
                let head = { ...snake[0] };
                if (direction === 'right') head.x++;
                if (direction === 'left') head.x--;
                if (direction === 'up') head.y--;
                if (direction === 'down') head.y++;

                if (head.x < 0 || head.x >= snakeCanvas.width / gridSize || head.y < 0 || head.y >= snakeCanvas.height / gridSize || snake.some(p => p.x === head.x && p.y === head.y)) {
                    return startSnakeGame(); // Reset game
                }

                snake.unshift(head);
                if (head.x === food.x && head.y === food.y) {
                    score++;
                    snakeScoreEl.textContent = `Score: ${score}`;
                    food = { x: Math.floor(Math.random() * (snakeCanvas.width / gridSize)), y: Math.floor(Math.random() * (snakeCanvas.height / gridSize)) };
                } else {
                    snake.pop();
                }

                snakeCtx.fillStyle = 'black';
                snakeCtx.fillRect(0, 0, snakeCanvas.width, snakeCanvas.height);
                snakeCtx.fillStyle = 'lime';
                snake.forEach(p => snakeCtx.fillRect(p.x * gridSize, p.y * gridSize, gridSize - 2, gridSize - 2));
                snakeCtx.fillStyle = 'red';
                snakeCtx.fillRect(food.x * gridSize, food.y * gridSize, gridSize, gridSize);
            }
            document.addEventListener('keydown', e => {
                if (document.getElementById('snake-game').style.display !== 'none') {
                    if (e.key === 'ArrowUp' && direction !== 'down') direction = 'up';
                    if (e.key === 'ArrowDown' && direction !== 'up') direction = 'down';
                    if (e.key === 'ArrowLeft' && direction !== 'right') direction = 'left';
                    if (e.key === 'ArrowRight' && direction !== 'left') direction = 'right';
                }
            });

            // Pong Game
            let ball, player, ai, pongCanvas, pongCtx, pongScoreEl;
            function initializePongGame() {
                pongCanvas = document.getElementById('pong-canvas');
                pongCtx = pongCanvas.getContext('2d');
                pongScoreEl = document.getElementById('pong-score');
                pongCanvas.addEventListener('mousemove', e => {
                    const rect = pongCanvas.getBoundingClientRect();
                    player.y = e.clientY - rect.top - player.height / 2;
                });
                gamesInitialized.pong = true;
            }
            function startPongGame() {
                if (!pongCanvas) return;
                ball = { x: pongCanvas.width / 2, y: pongCanvas.height / 2, dx: 5, dy: 2, radius: 8 };
                player = { x: 10, y: pongCanvas.height / 2 - 40, width: 10, height: 80, score: 0 };
                ai = { x: pongCanvas.width - 20, y: pongCanvas.height / 2 - 40, width: 10, height: 80, score: 0 };
                if (gameIntervals['pong-game']) clearInterval(gameIntervals['pong-game']);
                gameIntervals['pong-game'] = setInterval(updatePongGame, 1000 / 60);
            }
            function updatePongGame() {
                if (!pongCanvas) return;
                ball.x += ball.dx;
                ball.y += ball.dy;
                if (ball.y + ball.radius > pongCanvas.height || ball.y - ball.radius < 0) ball.dy *= -1;
                if (ball.x - ball.radius < player.x + player.width && ball.y > player.y && ball.y < player.y + player.height) ball.dx *= -1;
                if (ball.x + ball.radius > ai.x && ball.y > ai.y && ball.y < ai.y + ai.height) ball.dx *= -1;
                if (ball.x < 0) { ai.score++; startPongGame(); }
                if (ball.x > pongCanvas.width) { player.score++; startPongGame(); }
                ai.y += (ball.y - (ai.y + ai.height / 2)) * 0.1;
                pongScoreEl.textContent = `Player: ${player.score} | AI: ${ai.score}`;
                pongCtx.fillStyle = 'black';
                pongCtx.fillRect(0, 0, pongCanvas.width, pongCanvas.height);
                pongCtx.fillStyle = 'white';
                pongCtx.fillRect(player.x, player.y, player.width, player.height);
                pongCtx.fillRect(ai.x, ai.y, ai.width, ai.height);
                pongCtx.beginPath();
                pongCtx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
                pongCtx.fill();
            }
            
            // Tic-Tac-Toe Game
            let tttBoard, tttCurrentPlayer, tttGameOver, tttGrid, tttStatus, tttResetBtn;
            function initializeTicTacToeGame() {
                tttGrid = document.getElementById('tictactoe-grid');
                tttStatus = document.getElementById('tictactoe-status');
                tttResetBtn = document.getElementById('tictactoe-reset');
                // Clear any existing cells before creating new ones
                tttGrid.innerHTML = ''; 
                for(let i = 0; i < 9; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'tic-tac-toe-cell';
                    cell.dataset.index = i;
                    cell.addEventListener('click', handleTTTClick);
                    tttGrid.appendChild(cell);
                }
                tttResetBtn.addEventListener('click', startTicTacToeGame);
                gamesInitialized.tictactoe = true;
            }
            function startTicTacToeGame() {
                if (!tttGrid) return;
                tttBoard = Array(9).fill(null);
                tttCurrentPlayer = 'X';
                tttGameOver = false;
                tttStatus.textContent = `Player ${tttCurrentPlayer}'s turn`;
                document.querySelectorAll('.tic-tac-toe-cell').forEach(cell => cell.textContent = '');
            }
            function handleTTTClick(e) {
                const index = e.target.dataset.index;
                if (tttBoard[index] || tttGameOver) return;
                tttBoard[index] = tttCurrentPlayer;
                e.target.textContent = tttCurrentPlayer;
                checkTTTWinner();
                if (!tttGameOver) {
                    tttCurrentPlayer = tttCurrentPlayer === 'X' ? 'O' : 'X';
                    tttStatus.textContent = `Player ${tttCurrentPlayer}'s turn`;
                }
            }
            function checkTTTWinner() {
                const winConditions = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
                for (let condition of winConditions) {
                    const [a, b, c] = condition;
                    if (tttBoard[a] && tttBoard[a] === tttBoard[b] && tttBoard[a] === tttBoard[c]) {
                        tttStatus.textContent = `Player ${tttCurrentPlayer} wins!`;
                        tttGameOver = true;
                        return;
                    }
                }
                if (!tttBoard.includes(null)) {
                    tttStatus.textContent = "It's a draw!";
                    tttGameOver = true;
                }
            }
            
            initializeOS();
            console.log("Booting ComOS...");
        });
    </script>
</body>
</html>
